rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "rvimman@gmail.com";
    }
    
    // Users collection rules
    match /users/{userId} {
      // Allow read access to any user's profile
      allow read: if true;
      
      // Only allow users to update their own profile or admin can update any
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
      
      // Only allow users to create their own profile
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Only allow users to delete their own profile or admin can delete any
      allow delete: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
    }
    
    // Blog posts collection rules
    match /blogPosts/{postId} {
      // Allow read access to all
      allow read: if true;
      
      // Only allow authenticated users to create posts
      allow create: if request.auth != null;
      
      // Only allow post authors or admins to update/delete
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.authorId || isAdmin()
      );
    }
    
    // Post views collection rules
    match /post_views/{postId} {
      // Allow read access to all
      allow read: if true;
      
      // Only allow server-side updates to increment view counts
      allow write: if request.auth != null && request.auth.uid == 'firebase';
      
      // For development, allow all writes
      // TODO: Remove in production
      allow write: if true;
    }

    // Comments collection rules
    match /comments/{commentId} {
      // Allow public read access to all comments
      allow read: if true;
      
      // Allow any authenticated user to create comments with required fields
      allow create: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.displayName is string
        && request.resource.data.displayName.size() >= 1
        && request.resource.data.displayName.size() <= 100
        && request.resource.data.content is string
        && request.resource.data.content.size() >= 1
        && request.resource.data.content.size() <= 5000
        && (request.resource.data.photoURL == null || request.resource.data.photoURL is string)
        && request.resource.data.email is string
        && request.resource.data.timestamp is timestamp
        && request.resource.data.upvotes is number
        && request.resource.data.downvotes is number
        && request.resource.data.upvoters is list
        && request.resource.data.downvoters is list;
      
      // Allow users to update their own comments (content, displayName, photoURL)
      allow update: if request.auth != null && (
        // User is the comment author
        (resource.data.uid == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'displayName', 'photoURL'])
        && request.resource.data.content is string
        && request.resource.data.content.size() >= 1
        && request.resource.data.content.size() <= 5000
        && request.resource.data.displayName is string
        && request.resource.data.displayName.size() >= 1
        && request.resource.data.displayName.size() <= 100
        && (request.resource.data.photoURL == null || request.resource.data.photoURL is string))
      ) || (
        // Allow voting updates
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes', 'downvotes', 'upvoters', 'downvoters'])
        && request.resource.data.upvotes is number
        && request.resource.data.downvotes is number
        && request.resource.data.upvoters is list
        && request.resource.data.downvoters is list
        && request.resource.data.upvotes >= 0
        && request.resource.data.downvotes >= 0
      );
      
      // Allow users to delete their own comments
      allow delete: if request.auth != null && resource.data.uid == request.auth.uid;
    }

    // New membership and subscription collections
    
    // Creator profiles collection
    match /creatorProfiles/{creatorId} {
      // Allow public read access to creator profiles
      allow read: if true;
      
      // Only allow creators to create/update their own profile
      allow create, update: if request.auth != null && request.auth.uid == creatorId;
      
      // Only allow creators to delete their own profile or admin can delete any
      allow delete: if request.auth != null && (
        request.auth.uid == creatorId || isAdmin()
      );
    }
    
    // User subscriptions collection
    match /userSubscriptions/{subscriptionId} {
      // Users can read their own subscriptions
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || 
        resource.data.creatorId == request.auth.uid ||
        isAdmin()
      );
      
      // Users can create subscriptions to creators
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userId != request.resource.data.creatorId;
      
      // Users can update their own subscriptions
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Users can delete their own subscriptions
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Blog subscriptions collection
    match /blogSubscriptions/{subscriptionId} {
      // Users can read their own blog subscriptions
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || 
        isAdmin()
      );
      
      // Users can create blog subscriptions
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own blog subscriptions
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Users can delete their own blog subscriptions
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}